<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>å…¬æ¬ ãƒ»å¿Œå¼•å±Š</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&amp;display=swap" rel="stylesheet"/>
<style>
    body {
      font-family: 'Noto Sans JP', sans-serif;
      background-color: #f2f4f6;
      margin: 0;
      padding: 1rem;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #104e74;
      font-size: 1.8rem;
      text-align: center;
      margin-bottom: 1rem;
    }
    .login-badge {
      background-color: #104e74;
      color: #fff;
      font-weight: 600;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      text-align: center;
      margin-bottom: 1.5rem;
      font-size: 0.95rem;
    }
    label {
      font-weight: 600;
      margin-top: 0.8rem;
      display: block;
      font-size: 0.95rem;
    }
    select, input[type="date"], input[type="text"], input[type="file"], textarea {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.2rem;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
      font-size: 0.95rem;
    }
    button {
      background-color: #104e74;
      color: white;
      padding: 0.7rem 1rem;
      font-size: 0.95rem;
      border: none;
      border-radius: 6px;
    }
    button:hover {
      background-color: #0d3e5d;
      cursor: pointer;
    }
    .step {
      display: none;
      margin-bottom: 1rem;
      border: 1px solid #ccc;
      padding: 1rem;
      border-radius: 8px;
      background: #f8fbfd;
    }
    .step.active { display: block; }
    .nav-buttons {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      margin-top: 1rem;
    }

     .entry-card {
      background: #eef4f8;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 0.8rem;
      margin: 1rem 0;
    }
    #entryList {
      margin-top: 2rem;
    }

    .sticky-footer {
      position: sticky;
      bottom: 0;
      margin-top: 2rem;
      background: white;
      padding-top: 1rem;
    }
    .text-link-button {
  font-size: 0.85rem;
  background: none;
  border: none;
  color: #555;
  text-decoration: underline;
  padding: 0;
  cursor: pointer;
}
#confirmAddModal .modal-content {
  text-align: center;
  max-width: 400px;
  font-size: 1rem;
}

#confirmAddModal h3 {
  margin-top: 0;
  font-size: 1.1rem;
  color: #104e74;
}

#confirmAddModal .modal-buttons {
  margin-top: 1.5rem;
  display: flex;
  justify-content: space-around;
  gap: 1rem;
}

#confirmAddModal .modal-buttons button {
  padding: 0.5rem 1rem;
  border-radius: 6px;
  border: none;
  font-size: 0.95rem;
}

#confirmAddModal .modal-buttons button:first-child {
  background-color: #104e74;
  color: white;
}

#confirmAddModal .modal-buttons button:last-child {
  background-color: #ccc;
  color: #333;
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background-color: rgba(0, 0, 0, 0.6);
  justify-content: center;
  align-items: center;
  z-index: 9999;
}


.modal-content {
  background-color: #fff;
  padding: 1.5em 2em;
  border-radius: 12px;
  text-align: center;
  max-width: 90%;
  box-shadow: 0 4px 16px rgba(0,0,0,0.2);
  font-size: 1.2em;
}

.modal-button {
  margin-top: 1em;
  padding: 0.6em 1.2em;
  background-color: #004080;
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 1em;
  cursor: pointer;
}

.modal-button:hover {
  background-color: #0066cc;
}

#loadingSpinner {
  font-size: 1.3rem;
  color: #104e74;
  text-align: center;
  margin-top: 2rem;
  font-weight: bold;
}

/* ===== ã‚¹ãƒãƒ›æœ€é©åŒ–ç”¨ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ ===== */
@media screen and (max-width: 600px) {

  .nav-buttons {
    flex-direction: column;
    align-items: stretch;
  }

  .nav-buttons button,
  .nav-buttons .text-link-button {
    width: 100%;
    margin-bottom: 0.5rem;
    text-align: center;
  }

  button {
    font-size: 1rem;
    padding: 1rem;
  }

  input, select, textarea {
    font-size: 1rem;
  }

  .modal-content {
    padding: 1rem;
    font-size: 1rem;
  }

  .modal-buttons {
    flex-direction: column;
    gap: 0.5rem;
  }

  .modal-buttons button {
    width: 100%;
  }

}

.modal-buttons {
  display: flex;
  justify-content: center;
  gap: 1rem;
}

@media screen and (max-width: 600px) {
  .modal-buttons {
    flex-direction: column;
    gap: 0.5rem;
  }

  .modal-buttons button {
    width: 100%;
  }
}

.modal-buttons button:first-child {
  background-color: #ccc;
  color: #333;
}

.modal-buttons button:nth-child(2) {
  background-color: #1976d2;
  color: white;
}

.modal-buttons button:last-child {
  background-color: #388e3c;
  color: white;
}

#entryList {
  list-style: none;
  padding: 0;
}

#entryList li {
  margin-bottom: 0.5rem;
  padding: 0.5rem;
  background-color: #f8f8f8;
  border-radius: 4px;
}

.text-link-button {
  font-size: 0.85rem;
  background: none;
  border: none;
  color: #d00;
  text-decoration: underline;
  cursor: pointer;
}

.file-list-remove-btn {
  background: #e0e0e0;
  color: #555;
  font-size: 0.85rem;
  border: none;
  border-radius: 4px;
  padding: 0.2em 0.6em;
  margin-left: 0.6em;
  cursor: pointer;
  vertical-align: middle;
  transition: background 0.2s;
}
.file-list-remove-btn:hover {
  background: #ffcccc;
  color: #d00;
}


/* æ·»ä»˜æ›¸é¡ã‚¬ã‚¤ãƒ‰ç”¨ãƒœã‚¿ãƒ³ */
.guide-buttons {
  display: flex;
  justify-content: center;   /* ä¸­å¤®å¯„ã› */
  gap: 1rem;                  /* ãƒœã‚¿ãƒ³é–“ã®éš™é–“ */
  margin: 1.5em 0;            /* ä¸Šä¸‹ãƒãƒ¼ã‚¸ãƒ³ */
}

.guide-buttons a {
  display: inline-block;
  padding: 0.6em 1.2em;      /* ãƒœã‚¿ãƒ³å†…ä½™ç™½ */
  font-size: 0.85rem;
  font-weight: 500;
  border-radius: 4px;         /* è§’ä¸¸ */
  text-decoration: none;
  transition: background-color 0.2s ease;
}

/* å…¬æ¬ å±Šã‚¬ã‚¤ãƒ‰ï¼ˆé’ï¼‰ */
.guide-buttons a.guide-public {
  background-color: #007bff;
  color: #fff;
}
.guide-buttons a.guide-public:hover {
  background-color: #0069d9;
}

/* å¿Œå¼•å±Šã‚¬ã‚¤ãƒ‰ï¼ˆç·‘ï¼‰ */
.guide-buttons a.guide-funeral {
  background-color: #28a745;
  color: #fff;
}
.guide-buttons a.guide-funeral:hover {
  background-color: #218838;
}

/* æ³¨æ„æ›¸ãå…¨ä½“ */
.note-text {
  font-size: 0.9rem;
  color: #555;
  margin-top: 0.5rem;
  line-height: 1.4;
}

/* å¼·èª¿ãƒ–ãƒ­ãƒƒã‚¯ */
.note-text__important {
  display: block;               /* ç‹¬ç«‹ã—ãŸæ®µè½ã« */
  margin: 0.75em 0 0;           /* ä¸Šã«ä½™ç™½ã‚’ */
  padding: 0.5em 1em;           /* å†…å´ä½™ç™½ */
  background-color: #f8d7da;    /* è–„ã„èµ¤ç³»èƒŒæ™¯ */
  border-left: 4px solid #f5c6cb;/* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã®å·¦ãƒ©ã‚¤ãƒ³ */
  color: #721c24;               /* æ–‡å­—è‰²ã‚’æ¿ƒã„èµ¤ç³»ã« */
  font-weight: 700;             /* å¤ªå­— */
  border-radius: 4px;
}

  </style>
</head>
<body>
<div class="container">
<h1>å…¬æ¬ ãƒ»å¿Œå¼•å±Š</h1>
<div class="login-badge">
<?= student.name ?> ã•ã‚“ï¼ˆ<?= student.email ?>ï¼‰ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ä¸­
    </div>
<form id="absenceForm">
<div id="errorBox"></div>
<!-- Step 1 -->
<div class="step active" id="step1">

<label for="reason">ç”³è«‹ç†ç”±</label>
<select id="reason" name="reason" required="">
<option value="">é¸æŠã—ã¦ãã ã•ã„</option>
<option value="1"> ã‚¤ãƒ³ãƒ•ãƒ«ãƒ»ã‚³ãƒ­ãƒŠç­‰ã«ã‚ˆã‚‹å‡ºå¸­åœæ­¢</option>
<option value="2"> å­¦æ ¡ä¿å¥æ³•æ–½è¡Œè¦å‰‡ã«ã‚ˆã‚‹æ„ŸæŸ“ç—‡</option>
<option value="3"> äº¤é€šæ©Ÿé–¢ã®é…å»¶ãƒ»é‹ä¼‘</option>
<option value="4"> ã‚¯ãƒ©ãƒ–æ´»å‹•ä¸­ã®ã‚±ã‚¬</option>
<option value="5"> æˆæ¥­ä¸­ã®ã‚±ã‚¬</option>
<option value="6"> å¯®ç”Ÿæ´»ä¸­ã§ã®ã‚±ã‚¬</option>
<option value="7"> å°±è·æ´»å‹•</option>
<option value="8"> å¤§å­¦ç­‰æ¨è–¦å—é¨“</option>
<option value="9"> ã‚¯ãƒ©ãƒ–ã®è©¦åˆ</option>
<option value="10"> å­¦ä¼šç™ºè¡¨ç­‰</option>
<option value="11"> å¿Œå¼•ãï¼ˆè‘¬å„€ç­‰ï¼‰</option>
<option value="other"> ãã®ä»–ï¼ˆç†ç”±ã‚’è¨˜å…¥ï¼‰</option>
</select>
<div id="stepOther" style="display:none;">
<label for="otherReason">ãã®ä»–ã®ç†ç”±ï¼ˆå¿…é ˆï¼‰</label>
<input id="otherReason" name="otherReason" type="text"/>
</div>
<!-- âœ… ãƒœã‚¿ãƒ³ã®ä¸¦ã³ã‚’ä¿®æ­£ï¼šå·¦ï¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€å³ï¼æ¬¡ã¸ -->
<div class="nav-buttons" style="justify-content: flex-end;">
<button aria-label="ã‚¹ãƒ†ãƒƒãƒ—2ã¸é€²ã‚€" onclick="window.showStep(2)" type="button">æ¬¡ã¸</button>
</div>
</div>
<!-- Step 2 -->
<!-- Step 2ï¼šé–‹å§‹ãƒ»çµ‚äº†æ—¥ã‚’1ç”»é¢ã§ -->
<div class="step" id="step2">
  <p>â€»æ¬ å¸­æœŸé–“ã¯æœ¬æ—¥ã‚’å«ã‚ã€å‰å¾Œ1ã‹æœˆä»¥å†…ã®ã¿ç”³è«‹å¯èƒ½ã§ã™</p>

  <label for="from">æ¬ å¸­é–‹å§‹æ—¥</label>
  <input id="from" name="from" required type="date">

  <label for="periodFrom">ä½•é™ç›®ã‹ã‚‰</label>
<select id="periodFrom" name="periodFrom" required>
  <option value="">é¸æŠ</option>
  <option value="SHR">SHR</option>
  <option value="1é™">1é™</option>
  <option value="2é™">2é™</option>
  <option value="3é™">3é™</option>
  <option value="4é™">4é™</option>
  <option value="5é™">5é™</option>
  <option value="6é™">6é™</option>
  <option value="7é™">7é™</option>
  <option value="8é™">8é™</option>
  <option value="9é™">9é™</option>
  <option value="10é™">10é™</option>
</select>

<label for="to" style="margin-top:1.5em;">æ¬ å¸­çµ‚äº†æ—¥</label>
<input id="to" name="to" required type="date">

<label for="periodTo">ä½•é™ç›®ã¾ã§</label>
<select id="periodTo" name="periodTo" required>
  <option value="">é¸æŠ</option>
  <option value="SHR">SHR</option>
  <option value="1é™">1é™</option>
  <option value="2é™">2é™</option>
  <option value="3é™">3é™</option>
  <option value="4é™">4é™</option>
  <option value="5é™">5é™</option>
  <option value="6é™">6é™</option>
  <option value="7é™">7é™</option>
  <option value="8é™">8é™</option>
  <option value="9é™">9é™</option>
  <option value="10é™">10é™</option>
</select>


  <div class="nav-buttons" style="justify-content: flex-end; gap: 1rem;">
    <button aria-label="ã‚¹ãƒ†ãƒƒãƒ—1ã«æˆ»ã‚‹" onclick="window.showStep(1, true)" type="button"
      style="background-color: #aaa; color: white;">
      â¬… æˆ»ã‚‹
    </button>
    <button aria-label="ã‚¹ãƒ†ãƒƒãƒ—3ã¸é€²ã‚€" onclick="window.showStep(3)" type="button"
      style="background-color: #104e74; color: white;">
      æ¬¡ã¸ â¡
    </button>
  </div>
</div>

<!-- Step 4 -->
<div class="step" id="step3">
<label>æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆPDFãƒ»ç”»åƒç­‰ã€è¤‡æ•°å¯ï¼‰</label>
<div id="entryListContainer" style="margin-top: 1.5rem;">
<h4>ç¾åœ¨ã®ç”³è«‹å†…å®¹ï¼ˆåˆè¨ˆ <span id="entryCount">0</span> ä»¶ï¼‰</h4>
<ul id="entryList"></ul>
<!-- âœ… æœ€æ–°ã®ç”³è«‹å†…å®¹ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«å«ã‚€ï¼‰ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®è¿½åŠ æ  -->
</div>
<div id="fileContainer">
  <input type="file" id="fileInput" accept="application/pdf,image/*" multiple style="display:inline-block;">
  <ul id="fileList"></ul>
</div>
<p class="note-text">
  â€» æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã¯é¸æŠã—ãŸæ™‚ç‚¹ã§è‡ªå‹•çš„ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚<br/>
  <span class="note-text__important">
  â€» æ·»ä»˜ã¯åŸå‰‡å¿…é ˆã§ã™ã€‚<br/>
  â€» æ·»ä»˜ã§ããªã„å ´åˆã¯åŸæœ¬ã®ã‚³ãƒ”ãƒ¼ã‚’æå‡ºã™ã‚‹ã‹ã€æ•™å‹™éƒ¨ã¸ç›¸è«‡ã—ã¦ãã ã•ã„ã€‚
  </span>
</p>

<!-- âœ… ç”³è«‹ãŒç™»éŒ²ã•ã‚ŒãŸé€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
<div id="flashMessage" style="display:none; margin-top: 1rem; color: green; font-weight: bold; text-align: center;"></div>

<!-- âœ… ã‚¹ãƒ”ãƒŠãƒ¼ï¼ˆç”³è«‹ä¸­ã«è¡¨ç¤ºï¼‰ -->
<div id="formSpinner" style="display:none; margin: 1rem auto; text-align:center;">
  ğŸ”„ å‡¦ç†ä¸­â€¦
</div>

  <div class="guide-buttons">
    <a
      href="https://drive.google.com/file/d/1SdXHGAzUFRhRGb02BCYcm7deL-MNUDhh/view?usp=sharing"
      target="_blank"
      class="guide-public"
    >
      æ·»ä»˜æ›¸é¡ã‚¬ã‚¤ãƒ‰ã‚’è¦‹ã‚‹ï¼ˆå…¬æ¬ å±Šï¼‰
    </a>
    <a
      href="https://drive.google.com/file/d/1J1Y8JkzUCBh3tQxJ4HKd4VMDjzDRtH5P/view?usp=sharing"
      target="_blank"
      class="guide-funeral"
    >
      æ·»ä»˜æ›¸é¡ã‚¬ã‚¤ãƒ‰ã‚’è¦‹ã‚‹ï¼ˆå¿Œå¼•å±Šï¼‰
    </a>
  </div>

<!-- âœ… ãƒœã‚¿ãƒ³é…ç½®ï¼šä¸­å¤®å¯„ã› & é–“éš”ã‚ã‚Š -->
<div style="display:flex; justify-content:center; gap:1.5rem; margin-top:1rem;">
  <button onclick="window.showStep(2, true)" type="button" style="background-color:#aaa; color:white;">
    â¬… æˆ»ã‚‹
  </button>
  <button id="confirmBtn" onclick="window.openConfirmSummary(); return false;" type="button" style="background-color:#2e7d32; color:white;">
    âœ… ç”³è«‹ã™ã‚‹
  </button>
</div>

<!-- âœ… ã“ã®ç”³è«‹ã‚’ã‚„ã‚ã‚‹ãƒœã‚¿ãƒ³ -->
<div style="text-align: center; margin-top: 1rem;">
  <button id="cancelPendingEntry" class="text-link-button" style="display: none;" onclick="window.cancelCurrentEntry()">
    ã“ã®ç”³è«‹ã‚’ã‚„ã‚ã‚‹
  </button>
</div>
</div>

<!-- ä»¶æ•°è¡¨ç¤º -->
<div class="sticky-footer">
<div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
<button type="button" onclick="window.open('https://script.google.com/a/macros/ktc.ac.jp/s/AKfycbw_QfOs3fz0i51svJzbKGNAOOqbuxgM95vfrWM3DdrsKNuWaTXOtJk7DJMNH5OE6XZJKg/exec', '_blank')">
  ç”³è«‹çŠ¶æ³ã‚’ç¢ºèªã™ã‚‹
</button>
</div>
</div>
</form>

</div>

<!-- âœ… å‡¦ç†ä¸­ãƒ»å®Œäº†è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã“ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã¯åˆ¥ã«é…ç½®ã™ã‚‹ï¼‰ -->
<div class="modal" id="customModal">
<div class="modal-content">
     <!-- +++ ã“ã“ã‹ã‚‰ã‚¹ãƒ”ãƒŠãƒ¼ +++ -->
      <div id="modalSpinner" style="display:none; margin-top:1em;">
     <span class="spinner"></span> å‡¦ç†ä¸­â€¦
     </div>
      <!-- +++ ã“ã“ã¾ã§ã‚¹ãƒ”ãƒŠãƒ¼ +++ -->

 <div class="modal-buttons" style="margin-top: 1.5rem; justify-content: center;">
      <button class="modal-button" id="retryBtn" style="display:none;" onclick="window.submitConfirmed()">
      </button>
      <button class="modal-button" id="closeModalBtn" style="display:none;" onclick="window.closeModal()">
        âœ– é–‰ã˜ã‚‹
      </button>
    </div>
</div>
</div>

<!-- æ–°ï¼šç”³è«‹å†…å®¹ã®ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal" id="entrySummaryModal">
  <div class="modal-content">
   <h3 id="entrySummaryTitle">ç”³è«‹å†…å®¹ã®ç¢ºèª</h3>
    <div id="modalErrorBox" style="display:none; color:#d32f2f; margin-bottom:1rem;"></div>
    <div id="entrySummaryText" style="font-size: 0.95rem; text-align: left; margin-top: 1rem;"></div>
    <div id="fileSummaryText" style="font-size: 0.9rem; color: #444; margin-top: 1rem;"></div>
     <div id="loadingSpinner" style="display:none; margin-bottom:0.5rem;">é€ä¿¡ä¸­...</div>
     <div class="modal-buttons" id="beforeSubmitButtons" style="margin-top: 1.5rem;">
      <button id="goBackBtn" onclick="document.getElementById('entrySummaryModal').style.display='none'">
        â¬… å†…å®¹ã‚’ä¿®æ­£ã™ã‚‹ï¼ˆæˆ»ã‚‹ï¼‰
      </button>
      <button id="submitBtn" onclick="window.submitConfirmed()">
        âœ… ã“ã®å†…å®¹ã§ç”³è«‹ã™ã‚‹
      </button>
    </div>
    <div class="modal-buttons" id="afterSubmitButtons" style="margin-top: 1.5rem; display: none;">
      <button id="addMoreBtn" onclick="window.proceedNewEntry()">
        ï¼‹è¿½åŠ ã§ç”³è«‹ã™ã‚‹
      </button>
      <button id="closeSummaryBtn" onclick="window.closeSummaryModal()">
        é–‰ã˜ã‚‹
      </button>
    </div>
  </div>
</div>


<script defer="">
const entries = [];
let lastRegisteredIndex = null;
let cameFromAdd = false;
let fromStep3 = false;
let tempEntry = null;

    
    document.getElementById('reason').addEventListener('change', function () {
      document.getElementById('stepOther').style.display = this.value === 'other' ? 'block' : 'none';
    });

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = () => reject(new Error(`ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${file.name}ã€ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`));
    reader.readAsDataURL(file);
  });
}

window.showStep = function(n, skipValidation = false) {
  // step3ä»¥å¤–ãªã‚‰ fromStep3 ãƒ•ãƒ©ã‚°ãƒªã‚»ãƒƒãƒˆ
  if (n < 3) {
    fromStep3 = false;
  }

  const reason      = document.getElementById('reason');
  const from        = document.getElementById('from');
  const to          = document.getElementById('to');
  const periodFrom  = document.getElementById('periodFrom');
  const periodTo    = document.getElementById('periodTo');

  if (!skipValidation) {
    // ã‚¹ãƒ†ãƒƒãƒ—2 ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (n === 2 && reason.value === '') {
      showError('ç”³è«‹ç†ç”±ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }
    if (n === 2 && reason.value === 'other') {
      const otherText = document.getElementById('otherReason').value.trim();
      if (!otherText) {
        showError('ãã®ä»–ã®ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
    }

    // ã‚¹ãƒ†ãƒƒãƒ—3 ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼†ã‚¨ãƒ³ãƒˆãƒªä½œæˆ
    if (n === 3) {
      const otherReason = document.getElementById('otherReason').value.trim();

      if (!from.value || !periodFrom.value || !to.value || !periodTo.value) {
        showError('æ¬ å¸­é–‹å§‹æ—¥ãƒ»çµ‚äº†æ—¥ã€ä½•é™ç›®ã™ã¹ã¦ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      if (new Date(from.value) > new Date(to.value)) {
        showError('é–‹å§‹æ—¥ã¯çµ‚äº†æ—¥ã‚ˆã‚Šå‰ã®æ—¥ä»˜ã‚’æŒ‡å®šã—ã¦ãã ã•ã„');
        return;
      }
      if (from.value === to.value) {
        const periods = ['SHR','1é™','2é™','3é™','4é™','5é™','6é™','7é™','8é™','9é™','10é™'];
        if (periods.indexOf(periodFrom.value) > periods.indexOf(periodTo.value)) {
          showError('åŒä¸€æ—¥ã®å ´åˆã€ã€Œä½•é™ç›®ã‹ã‚‰ã€ã¯ã€Œä½•é™ç›®ã¾ã§ã€ã‚ˆã‚Šå‰ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
          return;
        }
      }

      // â”€â”€ ã‚¨ãƒ³ãƒˆãƒªä½œæˆ â”€â”€
      const newEntry = {
        reason:     reason.options[reason.selectedIndex].text,
        other:      reason.value === 'other' ? otherReason : '',
        from:       from.value,
        to:         to.value,
        periodFrom: periodFrom.value,
        periodTo:   periodTo.value
      };
      const exists = entries.some(e => isSameEntry(e.entry, newEntry));
      if (!exists) {
        entries.push({ entry: newEntry, files: currentFiles.slice() });
        currentFiles = [];
        updateFileListUI();
      }
      lastRegisteredIndex = entries.length - 1;
      tempEntry = null;

      // â”€â”€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–° â”€â”€
      const previewList = document.getElementById('entryList');
      const countDisplay = document.getElementById('entryCount');
      if (previewList && countDisplay) {
        previewList.innerHTML = '';
        const li = document.createElement('li');
        li.className = 'entry-item';
        const e = entries[entries.length - 1];
        const summary = `
          <strong>${e.entry.from}ï¼ˆ${e.entry.periodFrom}ï¼‰ã€œ${e.entry.to}ï¼ˆ${e.entry.periodTo}ï¼‰</strong><br>
          ç†ç”±ï¼š${e.entry.reason}${e.entry.other ? `ï¼ˆ${e.entry.other}ï¼‰` : ''}
        `;
        li.innerHTML = summary;
        previewList.appendChild(li);
        countDisplay.textContent = entries.length;
        const cancelBtn = document.getElementById('cancelPendingEntry');
        cancelBtn.style.display = (cameFromAdd && tempEntry !== null) ? 'inline' : 'none';
      }
    } // â”€â”€ if (n === 3) é–‰ã˜ â”€â”€
  } // â”€â”€ if (!skipValidation) é–‰ã˜ â”€â”€

  // ã‚¨ãƒ©ãƒ¼ã‚¯ãƒªã‚¢
  clearError();

  // ã‚¹ãƒ†ãƒƒãƒ—1ã«æˆ»ã‚‹ã¨ãã®åˆæœŸåŒ–
  if (n === 1) {
    if (!cameFromAdd) {
      entries.length = 0;
      updateEntryList();
      tempEntry = null;
    }
    cameFromAdd = false;
  }

  // ã€Œè¿½åŠ ã§ç”³è«‹ã€ã‹ã‚‰ã®æˆ»ã‚Šå‡¦ç†
  if (n === 3 && document.querySelector('.step.active')?.id === 'step3' && fromStep3) {
    entries.pop();
    updateEntryList();
    fromStep3 = false;
  }

  // å®Ÿéš›ã®ã‚¹ãƒ†ãƒƒãƒ—åˆ‡ã‚Šæ›¿ãˆ
  document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
  document.getElementById('step' + n).classList.add('active');
};

// ç”³è«‹ã”ã¨ã®filesé…åˆ—ç®¡ç†
let currentFiles = [];

// ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã§è‡ªå‹•è¿½åŠ 
document.getElementById('fileInput').addEventListener('change', function() {
  if (this.files.length > 0) {
    for (const f of this.files) {
      currentFiles.push(f);
    }
    this.value = ""; // inputãƒªã‚»ãƒƒãƒˆ
    updateFileListUI();
    if (entries.length > 0 && document.getElementById('step3').classList.contains('active')) {
      entries[entries.length - 1].files = currentFiles.slice();
    }
  }
});

function updateFileListUI() {
  const fileList = document.getElementById('fileList');
  if (!fileList) return;
  fileList.innerHTML = '';
  currentFiles.forEach((f, i) => {
    const li = document.createElement('li');
    li.innerHTML = `${f.name} (${Math.round(f.size/1024)}KB)
  <button class="file-list-remove-btn" onclick="removeFile(${i})">ğŸ—‘ï¸å‰Šé™¤</button>`;

    fileList.appendChild(li);
  });
}
window.removeFile = function(idx) {
  currentFiles.splice(idx, 1);
  updateFileListUI();
};


    function showError(message) {
      let errBox = document.getElementById('errorBox');
      errBox.textContent = message;
      errBox.style.background = '#ffdddd';
      errBox.style.color = '#900';
      errBox.style.padding = '0.8rem';
      errBox.style.marginBottom = '1rem';
      errBox.style.borderRadius = '6px';
      errBox.style.textAlign = 'center';
    }

    function clearError() {
      let errBox = document.getElementById('errorBox');
      errBox.textContent = '';
      errBox.removeAttribute('style');
    }


// æ¯”è¼ƒé–¢æ•°ï¼ˆisSameEntryï¼‰ã‚‚ script.html ã®ä¸­ã«è¿½åŠ 
function isSameEntry(a, b) {
  return a.reason === b.reason &&
         a.from === b.from &&
         a.to === b.to &&
         a.periodFrom === b.periodFrom &&
         a.periodTo === b.periodTo &&
         a.other === b.other;
}


function flashMessage(msg, duration = 3000) {
  const flash = document.getElementById('flashMessage');
  if (!flash) return;
  flash.textContent = msg;
  flash.style.display = 'block';
  setTimeout(() => {
    flash.style.display = 'none';
  }, duration);
}

function closeAddModal() {
  document.getElementById('confirmAddModal').style.display = 'none';
}


    // âœ… 1ã‹æœˆå‰å¾Œã®åˆ¶é™ã‚’æ—¥ä»˜å…¥åŠ›ã«è¨­å®š
function setDateLimits() {
  const today = new Date();
  const yyyyMMdd = (d) => d.toISOString().split("T")[0];

  const minDate = new Date(today);
  minDate.setDate(today.getDate() - 30);
  const maxDate = new Date(today);
  maxDate.setDate(today.getDate() + 30);

  document.getElementById('from').setAttribute('min', yyyyMMdd(minDate));
  document.getElementById('from').setAttribute('max', yyyyMMdd(maxDate));
  document.getElementById('to').setAttribute('min', yyyyMMdd(minDate));
  document.getElementById('to').setAttribute('max', yyyyMMdd(maxDate));
}

// âœ… ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰é€ä¿¡å®Ÿè¡Œï¼šGASã¸é€ã‚‹å‡¦ç†
window.submitConfirmed = async function() {
// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ã€Œé€ä¿¡ä¸­çŠ¶æ…‹ã€ã«åˆæœŸåŒ–
document.getElementById('retryBtn').style.display = 'none';
document.getElementById('closeModalBtn').style.display = 'none';
document.getElementById('beforeSubmitButtons').style.display = 'none';
document.getElementById('afterSubmitButtons').style.display = 'none';

// âœ… ã‚¿ã‚¤ãƒˆãƒ«ã‚’éè¡¨ç¤ºã«ã—ã¦ã€é€ä¿¡ä¸­ã‚’å¼·èª¿è¡¨ç¤º
const titleEl = document.getElementById('entrySummaryTitle');
if (titleEl) titleEl.style.display = 'none';

const spinner = document.getElementById('loadingSpinner');
spinner.style.display = 'block';
spinner.textContent = 'ğŸ”„ é€ä¿¡ä¸­...';


  try {
  const entrySummaryText = document.getElementById('entrySummaryText');
  const fileSummaryText = document.getElementById('fileSummaryText');
  const afterButtons = document.getElementById('afterSubmitButtons');
  const submitButton    = document.getElementById('submitBtn');
  const goBackButton    = document.getElementById('goBackBtn');
  const spinner         = document.getElementById('loadingSpinner');

  // â”€â”€â”€â”€â”€ äºŒé‡ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢ â”€â”€â”€â”€â”€
  submitButton.disabled = true;
  // â”€â”€â”€â”€â”€ ã‚¹ãƒ”ãƒŠãƒ¼è¡¨ç¤º â”€â”€â”€â”€â”€
  spinner.style.display = 'block';

  // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã‚’ã€Œé€ä¿¡ä¸­â€¦ã€ã«åˆ‡ã‚Šæ›¿ãˆ
  entrySummaryText.innerHTML ="";
  fileSummaryText.innerHTML = "";
  goBackButton.disabled = true;

  // ã‚¨ãƒ³ãƒˆãƒªãŒãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã—ã¦æˆ»ã™
  if (entries.length === 0) {
     // â”€â”€ ã‚¹ãƒ”ãƒŠãƒ¼ï¼ãƒœã‚¿ãƒ³çŠ¶æ…‹ æˆ»ã— â”€â”€
    spinner.style.display = 'none';
    submitButton.disabled = false;
    
    entrySummaryText.innerHTML = `
      <p style="text-align:center; color:#d32f2f;">
        ç”³è«‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚Step 1 ã«æˆ»ã£ã¦ãã ã•ã„ã€‚
      </p>`;
    goBackButton.disabled = false;
    submitButton.disabled = true;
    return;
  }

  // é‡è¤‡ã‚’æ’é™¤ã—ã¦ã‹ã‚‰ base64 å¤‰æ›
  const seen = new Set();
  const uniqueEntries = [];
  for (const e of entries) {
    const key = JSON.stringify(e.entry);
    if (!seen.has(key)) {
      uniqueEntries.push(e);
      seen.add(key);
    }
  }
  const finalEntries = uniqueEntries.map(e => e.entry);
  const filesToSend = [];
  for (const e of uniqueEntries) {
    const fileObjs = [];
    for (const file of (e.files || [])) {
      const base64 = await fileToBase64(file);
      fileObjs.push({
        name: file.name,
        type: file.type,
        data: base64.split(',')[1]
      });
    }
    filesToSend.push(fileObjs);
  }

  // GAS å´ã®é–¢æ•°åã‚’ yourGASFunction ã«ç½®ãæ›ãˆã¦ãã ã•ã„
  google.script.run
    .withSuccessHandler((msg) => {
      // â”€â”€ æˆåŠŸæ™‚ã¯ã‚¹ãƒ”ãƒŠãƒ¼ã‚’éš ã—ã¦ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ– â”€â”€
      spinner.style.display = 'none';
      submitButton.disabled = false;
      goBackButton.disabled = false;

 const titleEl = document.getElementById('entrySummaryTitle');
if (titleEl) {
  titleEl.style.display = 'block';
  titleEl.textContent = 'ç”³è«‹å—ä»˜ã—ã¾ã—ãŸ';
}

      // é€ä¿¡æˆåŠŸæ™‚ï¼šãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã‚’ã€Œå—ä»˜å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ã«åˆ‡ã‚Šæ›¿ãˆ
      entrySummaryText.innerHTML = `
        <p style="text-align:center; font-size:1rem; color:#2e7d32; padding:1rem;">
           å…¬æ¬ ã®å¯å¦ã«ã¤ã„ã¦ã¯1é€±é–“ç¨‹åº¦ã§ã€Œç”³è«‹çŠ¶æ³ã‚’ç¢ºèªã™ã‚‹ã€ç”»é¢ã‹ã‚‰ã”ç¢ºèªãã ã•ã„ã€‚
        </p>`;
      fileSummaryText.innerHTML = "";

      // é€ä¿¡å¾Œã«è¡¨ç¤ºã™ã‚‹ãƒœã‚¿ãƒ³ç¾¤ã‚’è¡¨ç¤º
      afterButtons.style.display = 'flex';

      // ãƒ•ã‚©ãƒ¼ãƒ æœ¬ä½“ã‚’ãƒªã‚»ãƒƒãƒˆ
      cameFromAdd = false;
      entries.length = 0;
      updateEntryList();
      document.getElementById('stepOther').style.display = 'none';
      clearError();
    })
   .withFailureHandler((err) => {
    document.getElementById('retryBtn').style.display = 'inline-block';
       spinner.style.display = 'none';
       const msg = err.message ||
       "âŒ ç”³è«‹å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n" +
      "ï¼ˆåŸå› ï¼š " + (err.message||"ä¸æ˜") + "ï¼‰";
       // Lock å–å¾—å¤±æ•—ï¼ˆæ··é›‘ï¼‰æ™‚ã¯å°‚ç”¨ã‚¢ã‚¤ã‚³ãƒ³ï¼‹æ–‡è¨€ã«
       if (msg.includes("æ··é›‘ã—ã¦ã„ã¾ã™")) {
         entrySummaryText.innerHTML = `           
         <p style="text-align:center; color:#d9822b; padding:1rem;">
             âš ï¸ ã‚·ã‚¹ãƒ†ãƒ ãŒæ··ã¿åˆã£ã¦ã„ã¾ã™ã€‚æ•°ç§’å¾…ã£ã¦ã‹ã‚‰å†åº¦ã€Œç”³è«‹ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
           </p>`;       } else {         entrySummaryText.innerHTML = `
           <p style="text-align:center; color:#d32f2f; padding:1rem;">             âŒ ${msg}
           </p>`;
       }

       // ç”³è«‹ã™ã‚‹ãƒœã‚¿ãƒ³ã®ã¿å†æœ‰åŠ¹åŒ–
       submitButton.disabled = false;
       })
    .submitEntries(finalEntries, filesToSend);
 } catch (err) {
// äºˆæœŸã›ã¬åŒæœŸã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒ
flashMessage(`âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š${err.message}`, 5000);
 spinner.style.display = 'none';

   // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
  document.getElementById('submitBtn').disabled = false;
  document.getElementById('goBackBtn').disabled = false;
 }
};

window.cancelCurrentEntry = function () {
  tempEntry = null;
  document.getElementById('absenceForm').reset();
  document.getElementById('stepOther').style.display = 'none';
  clearError();

  updateEntryList();

  // âœ… æ¡ä»¶ï¼šç”³è«‹ãŒ1ä»¶ä»¥ä¸Šãªã‚‰ step3ï¼ˆä¸€è¦§ï¼‰ã¸ã€ã‚¼ãƒ­ä»¶ãªã‚‰ Step1 ã«æˆ»ã‚‹
  if (entries.length > 0) {
    showStep(3, true);
  } else {
    showStep(1, true);
  }
}

// âœ… ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«æ—¥ä»˜åˆ¶é™ã‚’è¨­å®š
window.addEventListener('load', () => {
  setDateLimits();
 
});


function closeModal() {
  const modal = document.getElementById('customModal');
  modal.style.display = 'none';

  // âœ… ãƒ•ã‚©ãƒ¼ãƒ åˆæœŸåŒ–
   document.getElementById('confirmBtn').disabled = false;
   document.getElementById('loadingSpinner').style.display = 'none';
  clearError();

   // âœ… ã‚¹ãƒ†ãƒƒãƒ—1ã«æˆ»ã‚‹
  setTimeout(() => showStep(1), 50);

  // âœ… ç”³è«‹å†…å®¹ã‚’ã‚¯ãƒªã‚¢
   entries.length = 0;  
  updateEntryList();
}


window.startNewEntry = function () {
  // âœ… æœªç™»éŒ²ã®tempEntryãŒã‚ã‚‹å ´åˆã¯å…ˆã«ä¿å­˜
  if (
    tempEntry &&
    tempEntry.reason &&
    tempEntry.from && tempEntry.to &&
    tempEntry.periodFrom && tempEntry.periodTo &&
    !entries.some(e => isSameEntry(e.entry, tempEntry))
  ) {
    entries.push({ entry: tempEntry, files: [] }); // filesã¯ç©ºã§ã‚‚ç™»éŒ²
  }

  tempEntry = null;
  cameFromAdd = true;
  fromStep3 = true;

  // âœ… ãƒ•ã‚©ãƒ¼ãƒ åˆæœŸåŒ–
  document.getElementById('absenceForm').reset();
  document.getElementById('stepOther').style.display = 'none';
  clearError();

  // âœ… ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦ Step1 ã«æˆ»ã‚‹
  document.getElementById('entrySummaryModal').style.display = 'none';
  setTimeout(() => showStep(1), 50);
};


function updateEntryList() {
  const list = document.getElementById("entryList");
  const countDisplay = document.getElementById("entryCount");
  if (!list || !countDisplay) return;

  list.innerHTML = "";

  if (entries.length === 0) {
    list.innerHTML = "<p>ç™»éŒ²ã•ã‚ŒãŸç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
    countDisplay.textContent = "0";
    return;
  }

[...entries].reverse().forEach((entryObj, reverseIndex) => {
  const index = entries.length - 1 - reverseIndex; // å…ƒã® index ã‚’ä¿æŒ

  const li = document.createElement("li");
  li.className = "entry-item";

  const e = entryObj.entry;
  const summary = `<strong>${e.from}ï¼ˆ${e.periodFrom}ï¼‰ã€œ${e.to}ï¼ˆ${e.periodTo}ï¼‰</strong><br>ç†ç”±ï¼š${e.reason}`;


  let html = summary;
 if (entryObj.files && entryObj.files.length > 0) {
  const fileNames = entryObj.files.map((f, fIdx) => {
  return `
    ğŸ“ ${f.name} (${Math.round(f.size / 1024)}KB)
    <button onclick="window.removeAttachedFile(${index}, ${fIdx})"
            style="margin-left: 0.5rem; font-size: 0.75rem; color: red; background: none; border: none; cursor: pointer;">
      ğŸ—‘ï¸å‰Šé™¤
    </button>
  `;
}).join("<br>");
  html += `<div style="font-size: 0.9rem; margin-top: 0.5rem; padding: 0.5rem; background: #e8f5e9; border-left: 4px solid #388e3c; border-radius: 4px; color: #2e7d32;">
    âœ… æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ${entryObj.files.length}ä»¶ï¼‰:<br>${fileNames}
  </div>`;
}
 else {
    html += `<div style="font-size: 0.85rem; margin-top: 0.4rem; color: #d32f2f; font-weight: 500;">
      æ·»ä»˜ãªã—ï¼ˆè¿½åŠ å¯èƒ½ï¼‰
    </div>`;
  }



  li.innerHTML = html;

  const deleteBtn = document.createElement("button");
  deleteBtn.textContent = `ğŸ—‘ï¸ ã“ã®ç”³è«‹ã‚’å‰Šé™¤`;
  deleteBtn.className = "text-link-button";
  deleteBtn.style.marginTop = "0.5rem";
  deleteBtn.onclick = () => {
    entries.splice(index, 1);  // å…ƒã®é…åˆ—ã‹ã‚‰æ­£ã—ã„ index ã‚’å‰Šé™¤
    updateEntryList();
  };

  li.appendChild(deleteBtn);

const editBtn = document.createElement("button");
editBtn.textContent = `âœï¸ ã“ã®ç”³è«‹ã‚’ç·¨é›†`;
editBtn.className = "text-link-button";
editBtn.style.marginLeft = "1rem";
editBtn.onclick = () => {
  window.editEntry(index);
};

li.appendChild(editBtn);


  list.appendChild(li);
});

  countDisplay.textContent = entries.length;

}

window.removeAttachedFile = function (entryIndex, fileIndex) {
  if (entries[entryIndex] && entries[entryIndex].files) {
    entries[entryIndex].files.splice(fileIndex, 1);  // æŒ‡å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
    flashMessage("ğŸ“ æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ", 2500);
    updateEntryList();  // å†æç”»
  }
};


window.editEntry = function(index) {
  const target = entries[index];
  if (!target) return;

  // entry æƒ…å ±ã‚’ tempEntry ã«ã‚³ãƒ”ãƒ¼
  tempEntry = { ...target.entry };
  cameFromAdd = true;
  entries.splice(index, 1);  // ç·¨é›†ã®ãŸã‚ä¸€æ—¦å‰Šé™¤
  updateEntryList();         // è¡¨ç¤ºæ›´æ–°

  // ç†ç”±ãªã©ã®å…¥åŠ›æ¬„ã«å€¤ã‚’å¾©å…ƒ
  const reasonValue = reverseLookupReason(tempEntry.reason);
  document.getElementById('reason').value = reasonValue;
  document.getElementById('from').value = tempEntry.from;
  document.getElementById('to').value = tempEntry.to;
  document.getElementById('periodFrom').value = tempEntry.periodFrom;
  document.getElementById('periodTo').value = tempEntry.periodTo;
  document.getElementById('otherReason').value = tempEntry.other || '';

  // ã€Œãã®ä»–ã€ãŒé¸ã°ã‚Œã¦ã„ãŸå ´åˆã®æ¬„ã‚’è¡¨ç¤º
  if (reasonValue === 'other') {
    document.getElementById('stepOther').style.display = 'block';
  } else {
    document.getElementById('stepOther').style.display = 'none';
  }

  // Step1 ã«ç§»å‹•
  showStep(1, true);
};


function reverseLookupReason(labelText) {
  const options = document.querySelectorAll('#reason option');
  for (const option of options) {
    if (option.textContent.trim() === labelText.trim()) {
      return option.value;
    }
  }
  return '';
}

 

window.addEventListener('unhandledrejection', (evt) => {
flashMessage(`âš ï¸ ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ï¼š${evt.reason?.message || evt.reason}`, 5000);
});



 // äºˆæœŸã›ã¬Promiseæ‹’å¦ã‚’ã‚­ãƒ£ãƒƒãƒã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã«
 window.addEventListener('unhandledrejection', event => {
   const modalErr = document.getElementById('modalErrorBox');
   modalErr.textContent = `äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š${event.reason?.message || event.reason}`;
   modalErr.style.display = 'block';
   // ã€Œç”³è«‹ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã ã‘å†æœ‰åŠ¹åŒ–
   document.getElementById('submitBtn').disabled = false;
   event.preventDefault();
 });

window.openConfirmSummary = function () {
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å†…å®¹ã‚¨ãƒªã‚¢å–å¾—

    if (entries.length > 0 && currentFiles.length > 0) {
    entries[entries.length - 1].files = currentFiles.slice();
  }

  const summaryContainer = document.getElementById('entrySummaryText');
  const fileContainer = document.getElementById('fileSummaryText');

  if (!summaryContainer || !fileContainer) return;

  let summaryHTML = '';
  let fileHTML = '';

  // ç”³è«‹ãƒ‡ãƒ¼ã‚¿ï¼ˆentriesï¼‰ã‚’ãƒ«ãƒ¼ãƒ—ã—ã¦å†…å®¹ã‚’ç”Ÿæˆ
  entries.forEach((entryObj, index) => {
    const e = entryObj.entry;
    summaryHTML += `
      <div style="margin-bottom: 1rem;">
        <strong>ã€${index + 1}ä»¶ç›®ã€‘</strong><br>
        æ—¥ä»˜ï¼š${e.from}ï¼ˆ${e.periodFrom}ï¼‰ã€œ${e.to}ï¼ˆ${e.periodTo}ï¼‰<br>
        ç†ç”±ï¼š${e.reason}${e.other ? `ï¼ˆ${e.other}ï¼‰` : ''}
      </div>
    `;

    if (Array.isArray(entryObj.files) && entryObj.files.length > 0) {
      const files = entryObj.files
        .map(f => `- ${f.name}ï¼ˆ${Math.round(f.size / 1024)}KBï¼‰`)
        .join('<br>');
      fileHTML += `
        <div style="margin-bottom: 1rem;">
          <strong>${index + 1}. æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ï¼š</strong><br>${files}
        </div>
      `;
    } else {
      fileHTML += `
        <div style="margin-bottom: 1rem;">
          <strong>${index + 1}. æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ï¼š</strong><br>ãªã— ğŸš¨ï¼ˆå¿…è¦ãªå ´åˆã¯æ·»ä»˜ã—ã¦ãã ã•ã„ï¼‰
        </div>
      `;
    }
  });

  summaryContainer.innerHTML = summaryHTML.trim();
  fileContainer.innerHTML = fileHTML.trim();

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
  document.getElementById('entrySummaryTitle').textContent = 'ç”³è«‹å†…å®¹ã®ç¢ºèª';
  document.getElementById('entrySummaryModal').style.display = 'flex';
  document.getElementById('beforeSubmitButtons').style.display = 'flex';
document.getElementById('afterSubmitButtons').style.display = 'none';
document.getElementById('entrySummaryModal').style.display = 'flex';

};

window.closeSummaryModal = function() {
  // ç”³è«‹ãƒ‡ãƒ¼ã‚¿ã¨æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªã‚¢
  entries.length = 0;
  currentFiles.length = 0;
  tempEntry = null;
  updateEntryList();
  updateFileListUI && updateFileListUI();

  // ãƒ•ã‚©ãƒ¼ãƒ å†…å®¹ã‚’ãƒªã‚»ãƒƒãƒˆ
  document.getElementById('absenceForm').reset();
  document.getElementById('stepOther').style.display = 'none';
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤º
  document.getElementById('entrySummaryModal').style.display = 'none';

  // Step.1ã«æˆ»ã™
  window.showStep(1, true);
};


window.proceedNewEntry = function() {
  // ãƒªã‚»ãƒƒãƒˆå‡¦ç†
  entries.length = 0;
  currentFiles.length = 0;
  tempEntry = null;
  updateEntryList();
  updateFileListUI && updateFileListUI();
  document.getElementById('absenceForm').reset();
  document.getElementById('stepOther').style.display = 'none';
  document.getElementById('entrySummaryModal').style.display = 'none';
  window.showStep(1, true);
};

window.closeSummaryModal = function() {
  // å®Œå…¨ãƒªã‚»ãƒƒãƒˆï¼†é–‰ã˜ã‚‹
  entries.length = 0;
  currentFiles.length = 0;
  tempEntry = null;
  updateEntryList();
  updateFileListUI && updateFileListUI();
  document.getElementById('absenceForm').reset();
  document.getElementById('stepOther').style.display = 'none';
  document.getElementById('entrySummaryModal').style.display = 'none';
  window.showStep(1, true);
};


console.log("âœ… script loaded");
  console.log("typeof openConfirmSummary:", typeof window.openConfirmSummary);

</script>
</body>
</html>